<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- è¨­å®šæ‰‹æ©Ÿç‰ˆé¢ç¦æ­¢ç¸®æ”¾ï¼Œé¿å…æ“ä½œæ™‚ç•«é¢è·‘æ‰ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§å¯†äººè‡‰è¾¨è­˜ç³»çµ±</title>
    <!-- å¼•å…¥ Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Face-api.js (äººè‡‰è¾¨è­˜æ ¸å¿ƒ) -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { 
            background-color: #0f172a; /* æ·±è—è‰²èƒŒæ™¯ */
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: manipulation; /* å„ªåŒ–è§¸æ§ */
        }
        
        /* ç™»å…¥ç•«é¢æ¨£å¼ */
        #login-screen {
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 100; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: opacity 0.3s;
        }

        /* æ”å½±æ©Ÿå®¹å™¨ */
        .camera-wrapper { 
            position: relative; 
            width: 100%; 
            max-width: 500px; 
            margin: 0 auto; 
            aspect-ratio: 3/4; /* æ‰‹æ©Ÿç›´å‘æ¯”ä¾‹ */
            background: #000; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        
        /* å½±ç‰‡èˆ‡ç•«å¸ƒé¡åƒç¿»è½‰ï¼Œåƒç…§é¡å­ä¸€æ¨£ */
        video, canvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); 
            position: absolute;
            top: 0;
            left: 0;
        }

        /* å¢åŠ æ‰‹æ©ŸæŒ‰éˆ•çš„é»æ“Šå€åŸŸ */
        .btn-touch {
            min-height: 48px; 
            font-size: 16px;
        }

        /* é è¨­éš±è—ä¸»ç•«é¢ï¼Œç™»å…¥å¾Œæ‰é¡¯ç¤º */
        .app-content {
            display: none; 
        }
        .app-content.active {
            display: flex;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- =========================
         1. ç™»å…¥é–å®šç•«é¢ 
    ========================== -->
    <div id="login-screen">
        <div class="w-full max-w-sm text-center space-y-6">
            <div class="mb-4">
                <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto flex items-center justify-center mb-2 shadow-lg shadow-blue-500/50">
                    <span class="text-3xl">ğŸ”’</span>
                </div>
                <h1 class="text-2xl font-bold">ç§å¯†å­˜å–</h1>
                <p class="text-gray-400 text-sm">æ­¤ç³»çµ±å—å¯†ç¢¼ä¿è­·</p>
            </div>
            
            <div class="space-y-3">
                <input type="password" id="password-input" placeholder="è¼¸å…¥å¯†ç¢¼ (é è¨­ 1234)" 
                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-center text-xl tracking-widest focus:border-blue-500 outline-none transition text-white">
                
                <button id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold text-lg transition active:scale-95 shadow-lg">
                    è§£é–é€²å…¥
                </button>
            </div>
            <p id="login-msg" class="text-red-400 text-sm h-5"></p>
        </div>
    </div>

    <!-- =========================
         2. ä¸»æ‡‰ç”¨ç¨‹å¼å…§å®¹ 
    ========================== -->
    <div id="app-container" class="app-content flex-col min-h-screen p-3 pb-10">
        <header class="text-center mb-4 mt-2 flex justify-between items-center px-2">
            <h1 class="text-xl font-bold text-blue-400">AI è¾¨è­˜ç³»çµ±</h1>
            <button onclick="logout()" class="text-xs text-gray-400 border border-gray-700 px-3 py-1 rounded hover:bg-gray-800">ç™»å‡º</button>
        </header>

        <!-- æ”å½±æ©Ÿå€ -->
        <div class="camera-wrapper border border-gray-700 relative">
            <!-- Loading é®ç½© -->
            <div id="loading-spinner" class="absolute inset-0 bg-black/90 flex flex-col justify-center items-center z-50 hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mb-3"></div>
                <p id="loading-text" class="text-sm font-light tracking-wider text-white">è¼‰å…¥ä¸­...</p>
            </div>
            <video id="video" autoplay muted playsinline></video>
        </div>

        <!-- è¨Šæ¯æç¤ºæ¡† -->
        <div id="msg-box" class="w-full max-w-lg mx-auto mt-3 p-3 rounded-lg text-sm text-center hidden font-bold shadow-md"></div>

        <!-- æ“ä½œé¢æ¿ -->
        <div class="w-full max-w-lg mx-auto mt-4 space-y-4">
            
            <!-- å•Ÿå‹•æŒ‰éˆ• -->
            <button id="btn-init" class="btn-touch w-full bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition active:scale-95">
                å•Ÿå‹•ç›¸æ©Ÿ
            </button>

            <!-- è¨»å†Šå€å¡Š (åˆå§‹éš±è—) -->
            <div id="register-panel" class="bg-gray-800 p-4 rounded-xl border border-gray-700 opacity-50 pointer-events-none transition-opacity shadow-xl">
                <h3 class="font-bold text-green-400 mb-3 text-sm uppercase flex justify-between items-center">
                    <span>â• æ–°å¢è¨˜æ†¶</span>
                    <span class="text-[10px] text-gray-500 bg-gray-900 px-2 py-1 rounded">è³‡æ–™åƒ…å­˜æœ¬åœ°</span>
                </h3>
                
                <div class="flex flex-col gap-3">
                    <input type="text" id="person-name" placeholder="è¼¸å…¥åå­— (ä¾‹: å°æ˜)" class="btn-touch px-4 rounded-lg bg-gray-900 border border-gray-600 text-white outline-none focus:border-green-500 transition">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <label class="btn-touch flex items-center justify-center bg-gray-700 active:bg-gray-600 rounded-lg cursor-pointer transition text-gray-200 hover:text-white">
                            <span class="text-sm font-bold">ğŸ“· é¸æ“‡ç…§ç‰‡</span>
                            <input type="file" id="upload-img" accept="image/*" class="hidden">
                        </label>
                        <button id="btn-register" class="btn-touch bg-green-600 active:bg-green-700 text-white rounded-lg font-bold shadow transition">
                            è¨»å†Š
                        </button>
                    </div>
                </div>

                <div class="mt-4 pt-3 border-t border-gray-700 text-xs text-gray-400 flex justify-between items-start">
                    <div class="max-w-[70%]">
                        <p class="mb-1">å·²è¨˜æ†¶åå–®ï¼š</p>
                        <p id="registered-list" class="text-white font-mono break-all">ç„¡</p>
                    </div>
                    <button id="btn-clear" class="text-red-400 border border-red-900/50 px-2 py-1 rounded bg-red-900/20 hover:bg-red-900/40 transition">
                        æ¸…é™¤è³‡æ–™
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // è¨­å®šå€
        // ==========================================
        const APP_PASSWORD = '1234'; // é è¨­å¯†ç¢¼ï¼Œè«‹åœ¨æ­¤ä¿®æ”¹
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models'; // æ¨¡å‹ä¾†æº
        const DB_KEY = 'face_app_private_db'; // LocalStorage å„²å­˜éµå€¼
        
        // ==========================================
        // è®Šæ•¸å®£å‘Š
        // ==========================================
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const passwordInput = document.getElementById('password-input');
        const loginMsg = document.getElementById('login-msg');
        const video = document.getElementById('video');
        const btnInit = document.getElementById('btn-init');
        const registerPanel = document.getElementById('register-panel');
        const msgBox = document.getElementById('msg-box');
        
        let isModelLoaded = false;
        let faceMatcher = null;
        let labeledDescriptors = [];
        let canvas = null;

        // ==========================================
        // 1. ç™»å…¥ç³»çµ±
        // ==========================================
        document.getElementById('btn-login').addEventListener('click', checkLogin);
        passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkLogin(); });

        function checkLogin() {
            if (passwordInput.value === APP_PASSWORD) {
                // æ·¡å‡ºç™»å…¥ç•«é¢
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    appContainer.classList.add('active'); // é¡¯ç¤ºä¸»ç¨‹å¼
                }, 300);
            } else {
                loginMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤';
                passwordInput.value = '';
                passwordInput.classList.add('border-red-500');
                setTimeout(() => passwordInput.classList.remove('border-red-500'), 1000);
            }
        }

        window.logout = function() {
            location.reload();
        }

        // ==========================================
        // 2. è³‡æ–™åº«é‚è¼¯ (LocalStorage)
        // ==========================================
        function saveToDatabase() {
            // å°‡ Float32Array è½‰ç‚ºæ™®é€šé™£åˆ—ä»¥ä¾¿ JSON å„²å­˜
            const dataToSave = labeledDescriptors.map(ld => ({
                label: ld.label,
                descriptors: ld.descriptors.map(desc => Array.from(desc))
            }));
            localStorage.setItem(DB_KEY, JSON.stringify(dataToSave));
        }

        function loadFromDatabase() {
            const dataStr = localStorage.getItem(DB_KEY);
            if (!dataStr) return;
            try {
                const data = JSON.parse(dataStr);
                // é‚„åŸç‚º FaceAPI æ ¼å¼
                labeledDescriptors = data.map(item => {
                    const descriptors = item.descriptors.map(d => new Float32Array(d));
                    return new faceapi.LabeledFaceDescriptors(item.label, descriptors);
                });
                if (labeledDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                    updateListUI();
                }
            } catch (e) {
                console.error('è³‡æ–™åº«è®€å–éŒ¯èª¤', e);
            }
        }

        // ==========================================
        // 3. æ ¸å¿ƒåŠŸèƒ½
        // ==========================================

        // æŒ‰éˆ• A: åˆå§‹åŒ–
        btnInit.addEventListener('click', async () => {
            btnInit.disabled = true;
            toggleLoading(true, 'æ­£åœ¨ä¸‹è¼‰ AI æ¨¡å‹ (ç´„éœ€ 10 ç§’)...');
            
            try {
                // åŠ è¼‰æ¨¡å‹ (SSD MobileNet V1 è¼ƒæº–ç¢º)
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);

                // è®€å–èˆŠè³‡æ–™
                loadFromDatabase();

                toggleLoading(true, 'æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...');

                // è«‹æ±‚ç›¸æ©Ÿ (å¼·åˆ¶å‰é¡é ­)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user', 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 } 
                    },
                    audio: false
                });
                video.srcObject = stream;
                
                // ç•¶å½±ç‰‡é–‹å§‹æ’­æ”¾
                video.onloadedmetadata = () => {
                    video.play();
                    isModelLoaded = true;
                    toggleLoading(false);
                    btnInit.classList.add('hidden'); // éš±è—æŒ‰éˆ•
                    registerPanel.classList.remove('opacity-50', 'pointer-events-none'); // å•Ÿç”¨è¨»å†Šå€
                    showMsg('ç³»çµ±å°±ç·’ï¼Œè«‹é–‹å§‹è¾¨è­˜æˆ–è¨»å†Š', 'success');
                    startDetectionLoop(); // é–‹å§‹è¿´åœˆ
                };

            } catch (err) {
                toggleLoading(false);
                btnInit.disabled = false;
                showMsg(`éŒ¯èª¤ï¼š${err.message}`, 'error');
            }
        });

        // æŒ‰éˆ• B: è¨»å†Š
        document.getElementById('btn-register').addEventListener('click', async () => {
            const name = document.getElementById('person-name').value.trim();
            const file = document.getElementById('upload-img').files[0];
            
            if (!name || !file) return showMsg('è«‹è¼¸å…¥åå­—ä¸¦é¸æ“‡ç…§ç‰‡', 'error');
            
            toggleLoading(true, `æ­£åœ¨åˆ†æ ${name} çš„ç‰¹å¾µ...`);
            
            try {
                const img = await faceapi.bufferToImage(file);
                // åµæ¸¬å–®ä¸€äººè‡‰
                const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                
                if (!detection) throw new Error('ç…§ç‰‡ä¸­æ‰¾ä¸åˆ°æ¸…æ™°çš„äººè‡‰ï¼Œè«‹æ›ä¸€å¼µ');
                
                // åŠ å…¥è¨˜æ†¶
                labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [detection.descriptor]));
                faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                
                // å­˜æª”èˆ‡æ›´æ–° UI
                saveToDatabase();
                updateListUI();
                
                document.getElementById('person-name').value = '';
                document.getElementById('upload-img').value = '';
                showMsg(`æˆåŠŸè¨˜ä½ï¼š${name}`, 'success');
                
            } catch (e) {
                showMsg(e.message, 'error');
            } finally {
                toggleLoading(false);
            }
        });

        // æŒ‰éˆ• C: æ¸…é™¤è³‡æ–™
        document.getElementById('btn-clear').addEventListener('click', () => {
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²è¨˜æ†¶çš„äººè‡‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                localStorage.removeItem(DB_KEY);
                labeledDescriptors = [];
                faceMatcher = null;
                updateListUI();
                showMsg('è³‡æ–™å·²æ¸…ç©º', 'info');
            }
        });

        // ==========================================
        // 4. åµæ¸¬è¿´åœˆ (Loop)
        // ==========================================
        async function startDetectionLoop() {
            // å»ºç«‹ Canvas
            if (!canvas) {
                canvas = faceapi.createCanvasFromMedia(video);
                document.querySelector('.camera-wrapper').append(canvas);
            }
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // æ¯ 100 æ¯«ç§’åŸ·è¡Œä¸€æ¬¡
            setInterval(async () => {
                if (!isModelLoaded || video.paused) return;
                
                // 1. åµæ¸¬æ‰€æœ‰äººè‡‰
                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                // 2. èª¿æ•´å°ºå¯¸
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                // 3. æ¸…ç©ºç•«å¸ƒ
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 4. ç¹ªè£½çµæœ
                resizedDetections.forEach(d => {
                    let label = 'Unknown';
                    let color = '#ef4444'; // ç´…è‰² (æœªçŸ¥)
                    
                    // å¦‚æœæœ‰è³‡æ–™åº«ï¼Œé€²è¡Œæ¯”å°
                    if (faceMatcher) {
                        const match = faceMatcher.findBestMatch(d.descriptor);
                        if (match.label !== 'unknown') {
                            // é¡¯ç¤ºåå­—èˆ‡ä¿¡å¿ƒåº¦ (è·é›¢è¶ŠçŸ­ä¿¡å¿ƒè¶Šé«˜)
                            label = `${match.label} (${Math.round((1-match.distance)*100)}%)`;
                            color = '#22c55e'; // ç¶ è‰² (èªè­˜)
                        }
                    }
                    
                    const box = d.detection.box;
                    const drawBox = new faceapi.draw.DrawBox(box, { 
                        label: label, 
                        boxColor: color,
                        drawLabelOptions: { backgroundColor: color } 
                    });
                    drawBox.draw(canvas);
                });
            }, 100);
        }

        // ==========================================
        // 5. è¼”åŠ©å·¥å…·
        // ==========================================
        function toggleLoading(show, text) {
            const spinner = document.getElementById('loading-spinner');
            document.getElementById('loading-text').textContent = text;
            spinner.className = show ? 'absolute inset-0 bg-black/90 flex flex-col justify-center items-center z-50' : 'hidden';
        }
        
        function updateListUI() {
            const list = document.getElementById('registered-list');
            list.textContent = labeledDescriptors.length ? labeledDescriptors.map(d => d.label).join(', ') : 'ç„¡';
        }

        function showMsg(text, type) {
            msgBox.textContent = text;
            msgBox.className = `w-full max-w-lg mx-auto mt-3 p-3 rounded-lg text-sm text-center font-bold shadow-md ${type === 'error' ? 'bg-red-500 text-white' : (type === 'success' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white')}`;
            msgBox.classList.remove('hidden');
            setTimeout(() => msgBox.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
